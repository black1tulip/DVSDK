#
# Makefile
#
# Makefile for OMAP3530 WinCE DVTB
#
# Copyright (C) 2010 Texas Instruments Incorporated - http://www.ti.com/ 
# 
# 
#  Redistribution and use in source and binary forms, with or without 
#  modification, are permitted provided that the following conditions 
#  are met:
#
#    Redistributions of source code must retain the above copyright 
#    notice, this list of conditions and the following disclaimer.
#
#    Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the 
#    documentation and/or other materials provided with the   
#    distribution.
#
#    Neither the name of Texas Instruments Incorporated nor the names of
#    its contributors may be used to endorse or promote products derived
#    from this software without specific prior written permission.
#
#  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS 
#  "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT 
#  LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
#  A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT 
#  OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, 
#  SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT 
#  LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
#  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
#  THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT 
#  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE 
#  OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#
#

ifndef DVTB_INSTALL_DIR
    DVTB_INSTALL_DIR = ../../../../../..
endif
include $(DVTB_INSTALL_DIR)/Rules.make

TARGET=dvtb

# Should the full command be echoed to the console during build?
VERBOSE=false
#VERBOSE=true

ifeq ($(VERBOSE), true)
    override PRE	=
else
    override PRE	= @
endif


    CPP_FLAGS_R		=
    WINCE_C_FLAGS_R	= -Ox -Ot

    CPP_FLAGS_D		= -DNDEBUG -D_DVEVM_ST_DEBUG_
    WINCE_C_FLAGS_D	= -Od -Zi


O3530_AW_TARGET		= $(TARGET)_omap3530

# Where to output configuration files
O3530_AW_XDC_CFG	= $(TARGET)_omap3530_config

# Executable names
O3530_AW_EXEC_R		= bin/$(TARGET).exe
O3530_AW_EXEC_D		= bin/$(TARGET)-d.exe

# Map files
O3530_AW_MAP_R		= $(O3530_AW_EXEC_R).map
O3530_AW_MAP_D		= $(O3530_AW_EXEC_D).map

# WinCE Program database file for executable
O3530_AW_EXEC_PDB_R	= $(O3530_AW_EXEC_R).pdb
O3530_AW_EXEC_PDB_D	= $(O3530_AW_EXEC_D).pdb

# WinCE Program database file for target object files
O3530_AW_OBJ_PDB_R	= $(TARGET)_wince_omap3530-r.pdb
O3530_AW_OBJ_PDB_D	= $(TARGET)_wince_omap3530-d.pdb

# WinCE temporary files generated by compiler/linker
WINCE_TEMP_FILES	= *.pdb bin/*.exp bin/*.lib bin/*.map bin/*.pdb

# Output compiler options
O3530_AW_XDC_CFLAGS		= $(O3530_AW_XDC_CFG)/compiler.opt

# Output linker file
O3530_AW_XDC_LFILE	= $(O3530_AW_XDC_CFG)/linker.cmd

# Input configuration file
O3530_AW_XDC_CFGFILE	= $(O3530_AW_TARGET).cfg

# Platform (board) to build for
O3530_AW_XDC_PLATFORM	= ti.platforms.evm3530

# Target tools
WINCE_XDC_TARGET 	= microsoft.targets.arm.WinCE

# The XDC configuration tool command line
CONFIGURO	= $(XDC_INSTALL_DIR)/xs xdc.tools.configuro 

CONFIG_BLD	= $(wildcard config.bld)



WINCE_CPP_FLAGS_R	= $(CPP_FLAGS_R) -Dxdc_target_types__=microsoft/targets/arm/std.h \
                      -nologo -WX -Zc:wchar_t- -Zc:forScope- -MT -GF -GR- -D_$(_TGTCPUFAMILY)_ -D$(_TGTCPUFAMILY) -D$(_TGTCPU) -DUNDER_CE=600 -D_WIN32_WCE=0x600 -DSTRICT -DWIN32 -QRarch4T -DTHUMBSUPPORT -QRinterwork-return -QRimplicit-import- -DUNICODE -D_UNICODE -DL0409 -DINTLSG_CODEPAGE=1252  -DWINCEOEM -DWINCEINTERNAL /Uinterface -GS -D_CRT_SECURE_NO_DEPRECATE -D_USE_32BIT_TIME_T -DOS_WINCE -DOS_WINCE_6_0 \
                      -I"$(_PROJECTROOT)"/cesysgen/sdk/inc	\
                      -I"$(_PROJECTROOT)"/cesysgen/oak/inc	\
                      -I$(DVTB_INSTALL_DIR)/packages/ti/sdo/dvtb/core/inc/common	\
                      -I$(DVTB_INSTALL_DIR)/packages/ti/sdo/dvtb/core/inc/wince	\
                      -I$(DVTB_INSTALL_DIR)/packages/ti/sdo/dvtb/osal	\
                      -I$(DVTB_INSTALL_DIR)/packages/ti/sdo/dvtb/omap3530/common	\
                      -I$(DVTB_INSTALL_DIR)/packages/ti/sdo/dvtb/omap3530/wince	\

WINCE_CPP_FLAGS_D	= $(CPP_FLAGS_D) -Dxdc_target_types__=microsoft/targets/arm/std.h \
                      -nologo -WX -Zc:wchar_t- -Zc:forScope- -MT -GF -GR- -D_$(_TGTCPUFAMILY)_ -D$(_TGTCPUFAMILY) -D$(_TGTCPU) -DUNDER_CE=600 -D_WIN32_WCE=0x600 -DSTRICT -DWIN32 -QRarch4T -DTHUMBSUPPORT -QRinterwork-return -QRimplicit-import- -DUNICODE -D_UNICODE -DL0409 -DINTLSG_CODEPAGE=1252  -DWINCEOEM -DWINCEINTERNAL /Uinterface -GS -D_CRT_SECURE_NO_DEPRECATE -D_USE_32BIT_TIME_T -DOS_WINCE -DOS_WINCE_6_0 \
                      -I"$(_PROJECTROOT)"/cesysgen/sdk/inc              \
                      -I"$(_PROJECTROOT)"/cesysgen/oak/inc              \
                      -I$(DVTB_INSTALL_DIR)/packages/ti/sdo/dvtb/core/inc/common       \
                      -I$(DVTB_INSTALL_DIR)/packages/ti/sdo/dvtb/core/inc/wince       \
                      -I$(DVTB_INSTALL_DIR)/packages/ti/sdo/dvtb/osal           \
                      -I$(DVTB_INSTALL_DIR)/packages/ti/sdo/dvtb/omap3530/common       \
                      -I$(DVTB_INSTALL_DIR)/packages/ti/sdo/dvtb/omap3530/wince       \
                      



WINCE_LD_FLAGS_R		= /nologo /LARGEADDRESSAWARE /opt:ref -nodefaultlib -incremental:no /base:0x00010000 -MERGE:.rdata=.text -align:4096 -ignore:4001,4070,4078,4086,4089,4096,4099,4108,4229 /STACK:65536,4096 /SUBSYSTEM:CONSOLE

WINCE_LD_FLAGS_D		= /nologo /LARGEADDRESSAWARE /opt:ref -nodefaultlib -debug -debugtype:cv -incremental:no /base:0x00010000 -MERGE:.rdata=.text -align:4096 -ignore:4001,4070,4078,4086,4089,4096,4099,4108,4229 /STACK:65536,4096 /SUBSYSTEM:CONSOLE


SOURCES 		= $(wildcard *.c) $(wildcard ../common/*.c) $(wildcard ../../core/common/*.c) $(wildcard ../../core/wince/*.c)
WINCE_SOURCES		= $(SOURCES) $(wildcard ../../osal/wince/*.c)

HEADERS			= $(wildcard *.h) $(wildcard ../common/*.h) $(wildcard ../../core/inc/common/*.h) $(wildcard ../../core/inc/wince/*.h) $(wildcard ../osal/*.h)
WINCE_HEADERS		= $(HEADERS) 

O3530_WINCE_OBJFILES_R	= $(WINCE_SOURCES:%.c=%.o3530-r.ov4TCE)
O3530_WINCE_OBJFILES_D	= $(WINCE_SOURCES:%.c=%.o3530-d.ov4TCE)


WINCE_COMPILE_R.c = $(PRE) $(WINCE_TOOL_DIR)/cl.exe $(WINCE_CPP_FLAGS_R) $(WINCE_C_FLAGS_R) -c
WINCE_LINK_R.c    = $(PRE) $(WINCE_TOOL_DIR)/link.exe $(WINCE_LD_FLAGS_R)

WINCE_COMPILE_D.c = $(PRE) $(WINCE_TOOL_DIR)/cl.exe $(WINCE_CPP_FLAGS_D) $(WINCE_C_FLAGS_D) -c
WINCE_LINK_D.c    = $(PRE) $(WINCE_TOOL_DIR)/link.exe $(WINCE_LD_FLAGS_D)



.PHONY: clean o3530_aw install

.NOTPARALLEL: $(O3530_AW_EXEC_R) $(O3530_AW_EXEC_D)

all:		o3530_aw install

install:
	$(PRE) copy bin\*.* $(EXEC_DIR)	

o3530_aw: $(O3530_AW_EXEC_R) $(O3530_AW_EXEC_D)
		
$(O3530_AW_EXEC_R):	$(O3530_AW_XDC_LFILE) $(O3530_WINCE_OBJFILES_R) \
					$(O3530_AW_LIBS) $(WINCE_LIBS)
	@echo
	@echo Linking $@ from $^..
#	Cannot use $^ here since WINCE Link does not take file as input
	$(WINCE_LINK_R.c) -map:$(O3530_AW_MAP_R) -pdb:$(O3530_AW_EXEC_PDB_R)  \
	                     -out:$@ $(O3530_WINCE_OBJFILES_R)            \
	                     $(shell $(XDC_INSTALL_DIR)/bin/cat $(O3530_AW_XDC_LFILE))  \
	                     $(O3530_AW_LIBS) $(WINCE_LIBS)

$(O3530_WINCE_OBJFILES_R):	%.o3530-r.ov4TCE: %.c $(WINCE_HEADERS) $(O3530_AW_XDC_CFLAGS) 
	echo Compiling $@ from $<..
	$(WINCE_COMPILE_R.c) $(shell $(XDC_INSTALL_DIR)/bin/cat $(O3530_AW_XDC_CFLAGS)) -Fd$(O3530_AW_OBJ_PDB_R) -Fo$@ $<
	

$(O3530_AW_EXEC_D):	$(O3530_AW_XDC_LFILE) $(O3530_WINCE_OBJFILES_D) \
					$(O3530_AW_LIBS) $(WINCE_LIBS)
	@echo
	@echo Linking $@ from $^..
#	Cannot use $^ here since WINCE Link does not take file as input
	$(WINCE_LINK_D.c) -map:$(O3530_AW_MAP_D) -pdb:$(O3530_AW_EXEC_PDB_D)  \
	                     -out:$@ $(O3530_WINCE_OBJFILES_D)            \
	                     $(shell $(XDC_INSTALL_DIR)/bin/cat $(O3530_AW_XDC_LFILE))  \
	                     $(O3530_AW_LIBS) $(WINCE_LIBS)

$(O3530_WINCE_OBJFILES_D):	%.o3530-d.ov4TCE: %.c $(WINCE_HEADERS) $(O3530_AW_XDC_CFLAGS) 
	echo Compiling $@ from $<..
	$(WINCE_COMPILE_D.c) $(shell $(XDC_INSTALL_DIR)/bin/cat $(O3530_AW_XDC_CFLAGS)) -Fd$(O3530_AW_OBJ_PDB_D) -Fo$@ $<
	
	
$(O3530_AW_XDC_LFILE) $(O3530_AW_XDC_CFLAGS): $(O3530_AW_XDC_CFGFILE)
	@echo ======== Building $(O3530_AW_TARGET) ========
	@echo Configuring application using $<
	$(PRE) $(CONFIGURO) -c $(WINCE_DIR) -o $(O3530_AW_XDC_CFG) -t $(WINCE_XDC_TARGET) -p $(O3530_AW_XDC_PLATFORM) -b $(CONFIG_BLD) $(O3530_AW_XDC_CFGFILE)

clean:
	@echo Removing generated files..
	$(PRE) -$(XDC_INSTALL_DIR)/bin/$(RM) -rf $(O3530_AW_XDC_CFG) $(O3530_WINCE_OBJFILES_R) $(O3530_WINCE_OBJFILES_D) $(O3530_AW_EXEC_R) $(O3530_AW_EXEC_D) $(WINCE_TEMP_FILES) *~ *.d .dep
